<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Partage Questionnaire - NikahScore</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #e91e63; 
            text-align: center; 
            margin-bottom: 30px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #e91e63;
            padding-bottom: 10px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e91e63;
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        input, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-sizing: border-box; 
        }
        button { 
            background: #e91e63; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 14px;
        }
        button:hover { 
            background: #c2185b; 
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 5px; 
            white-space: pre-wrap;
        }
        .success { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
        }
        .info { 
            background: #d1ecf1; 
            border: 1px solid #bee5eb; 
            color: #0c5460; 
        }
        .share-url {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            border: 1px solid #2196f3;
        }
        .step {
            counter-increment: step-counter;
            position: relative;
            padding-left: 40px;
            margin: 20px 0;
        }
        .step::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #e91e63;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .steps {
            counter-reset: step-counter;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Test du Partage de Questionnaire NikahScore</h1>
        
        <div class="test-section">
            <h2>üìã Test du syst√®me Couple</h2>
            <p><strong>Objectif :</strong> Cr√©er un questionnaire partag√© entre couples</p>
            
            <div class="steps">
                <div class="step">
                    <button onclick="createCouple()" id="btnCreateCouple">
                        üë• Cr√©er un questionnaire couple
                    </button>
                </div>
                
                <div class="step" id="stepJoin" style="display: none;">
                    <div class="form-group">
                        <label>Code du couple g√©n√©r√© :</label>
                        <input type="text" id="generatedCode" readonly>
                    </div>
                    <button onclick="joinCouple()" id="btnJoin">
                        ü§ù Rejoindre avec le code
                    </button>
                </div>
            </div>
            
            <div id="resultCouple"></div>
        </div>

        <div class="test-section">
            <h2>üì§ Test du syst√®me Shared</h2>
            <p><strong>Objectif :</strong> Partager un questionnaire avec r√©ponses</p>
            
            <div class="steps">
                <div class="step">
                    <button onclick="createSharedQuestionnaire()" id="btnCreateShared">
                        üìù Cr√©er un questionnaire partag√©
                    </button>
                </div>
                
                <div class="step" id="stepAccess" style="display: none;">
                    <div class="form-group">
                        <label>URL de partage g√©n√©r√©e :</label>
                        <div class="share-url" id="shareUrl"></div>
                    </div>
                    <button onclick="accessSharedQuestionnaire()" id="btnAccess">
                        üîó Tester l'acc√®s au questionnaire
                    </button>
                </div>
            </div>
            
            <div id="resultShared"></div>
        </div>

        <div class="test-section">
            <h2>üè† Test navigation depuis la landing</h2>
            <div class="steps">
                <div class="step">
                    <button onclick="testLandingPage()">
                        üè† Tester le lien "Questionnaire Partag√©" de la landing
                    </button>
                </div>
            </div>
            <div id="resultLanding"></div>
        </div>
    </div>

    <script>
        let generatedCoupleCode = '';
        let generatedShareCode = '';
        let shareUrl = '';

        function showResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // Test 1: Cr√©er un questionnaire couple
        async function createCouple() {
            const btn = document.getElementById('btnCreateCouple');
            btn.disabled = true;
            btn.textContent = '‚è≥ Cr√©ation en cours...';
            
            try {
                showResult('resultCouple', 'üë• Cr√©ation du questionnaire couple en cours...', 'info');
                
                const response = await fetch('/api/couple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: 'test-user-' + Date.now() 
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    generatedCoupleCode = data.couple_code;
                    document.getElementById('generatedCode').value = generatedCoupleCode;
                    document.getElementById('stepJoin').style.display = 'block';
                    
                    showResult('resultCouple', `‚úÖ Questionnaire couple cr√©√© !
üîë Code: ${data.couple_code}
üîó URL: ${data.share_url}
üë´ ID: ${data.couple_id}`, 'success');
                } else {
                    showResult('resultCouple', `‚ùå Erreur de cr√©ation:
Status: ${response.status}
Message: ${data.error || 'Erreur inconnue'}`, 'error');
                }
            } catch (error) {
                showResult('resultCouple', `‚ùå Erreur de connexion: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üë• Cr√©er un questionnaire couple';
            }
        }

        // Test 2: Rejoindre le couple
        async function joinCouple() {
            if (!generatedCoupleCode) {
                showResult('resultCouple', '‚ö†Ô∏è Cr√©ez d\'abord un questionnaire couple', 'error');
                return;
            }

            const btn = document.getElementById('btnJoin');
            btn.disabled = true;
            btn.textContent = '‚è≥ Connexion...';
            
            try {
                const response = await fetch(`/api/couple?code=${generatedCoupleCode}&user_id=test-partner-${Date.now()}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('resultCouple', `‚úÖ Connexion au couple r√©ussie !
üìä Donn√©es du couple r√©cup√©r√©es
üéØ Le syst√®me de partage couple fonctionne parfaitement !`, 'success');
                } else {
                    showResult('resultCouple', `‚ö†Ô∏è Probl√®me de connexion:
Status: ${response.status}
Message: ${data.error || 'Erreur inconnue'}`, 'error');
                }
            } catch (error) {
                showResult('resultCouple', `‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ù Rejoindre avec le code';
            }
        }

        // Test 3: Cr√©er un questionnaire partag√©
        async function createSharedQuestionnaire() {
            const btn = document.getElementById('btnCreateShared');
            btn.disabled = true;
            btn.textContent = '‚è≥ Cr√©ation...';
            
            try {
                showResult('resultShared', 'üìù Cr√©ation du questionnaire partag√©...', 'info');
                
                const mockResponses = {
                    question_1: 4,
                    question_2: 3,
                    question_3: 5,
                    // R√©ponses de test
                };

                const response = await fetch('/api/questionnaire/share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        responses: mockResponses,
                        user_id: 'test-shared-user-' + Date.now()
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    generatedShareCode = data.share_code;
                    shareUrl = data.share_url;
                    document.getElementById('shareUrl').textContent = shareUrl;
                    document.getElementById('stepAccess').style.display = 'block';
                    
                    showResult('resultShared', `‚úÖ Questionnaire partag√© cr√©√© !
üîë Code: ${data.share_code}
üîó URL: ${data.share_url}`, 'success');
                } else {
                    showResult('resultShared', `‚ùå Erreur de cr√©ation:
Status: ${response.status}
Message: ${data.error || 'Erreur inconnue'}`, 'error');
                }
            } catch (error) {
                showResult('resultShared', `‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìù Cr√©er un questionnaire partag√©';
            }
        }

        // Test 4: Acc√©der au questionnaire partag√©
        async function accessSharedQuestionnaire() {
            if (!generatedShareCode) {
                showResult('resultShared', '‚ö†Ô∏è Cr√©ez d\'abord un questionnaire partag√©', 'error');
                return;
            }

            const btn = document.getElementById('btnAccess');
            btn.disabled = true;
            btn.textContent = '‚è≥ Test acc√®s...';
            
            try {
                const response = await fetch(`/api/questionnaire/share?code=${generatedShareCode}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('resultShared', `‚úÖ Acc√®s au questionnaire partag√© r√©ussi !
üìä Donn√©es r√©cup√©r√©es
üéØ Le syst√®me de partage fonctionne parfaitement !`, 'success');
                } else {
                    showResult('resultShared', `‚ö†Ô∏è Probl√®me d'acc√®s:
Status: ${response.status}
Message: ${data.error || 'Erreur inconnue'}`, 'error');
                }
            } catch (error) {
                showResult('resultShared', `‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîó Tester l\'acc√®s au questionnaire';
            }
        }

        // Test 5: Navigation landing page
        function testLandingPage() {
            showResult('resultLanding', `üè† Test de navigation...
Redirection vers /questionnaire/shared`, 'info');
            
            // Simuler le clic sur le bouton de la landing page
            setTimeout(() => {
                window.open('/questionnaire/shared', '_blank');
                showResult('resultLanding', `‚úÖ Navigation test√©e !
üîó Page /questionnaire/shared ouverte dans un nouvel onglet
üéØ Le lien de la landing page fonctionne !`, 'success');
            }, 1000);
        }
    </script>
</body>
</html>